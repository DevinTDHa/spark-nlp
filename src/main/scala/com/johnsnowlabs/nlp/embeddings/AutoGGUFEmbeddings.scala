/*
 * Copyright 2017-2024 John Snow Labs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.johnsnowlabs.nlp.embeddings

import com.johnsnowlabs.ml.gguf.GGUFWrapper
import com.johnsnowlabs.ml.util.LlamaCPP
import com.johnsnowlabs.nlp._
import com.johnsnowlabs.nlp.llama.LlamaModel
import com.johnsnowlabs.nlp.util.io.ResourceHelper
import org.apache.spark.broadcast.Broadcast
import org.apache.spark.ml.util.Identifiable
import org.apache.spark.sql.SparkSession

/** Annotator that uses the llama.cpp library to generate text embeddings with large language
  * models.
  *
  * The type of embedding pooling can be set with the `setPoolingType` method. The default is
  * `"MEAN"`. The available options are `"NONE"`, `"MEAN"`, `"CLS"`, and `"LAST"`.
  *
  * For all settable parameters, and their explanations, see [[HasLlamaCppModelProperties]].
  *
  * Pretrained models can be loaded with `pretrained` of the companion object:
  * {{{
  * val autoGGUFModel = AutoGGUFEmbeddings.pretrained()
  *   .setInputCols("document")
  *   .setOutputCol("completions")
  * }}}
  * The default model is `"nomic-embed-text-v1.5.f16.gguf"`, if no name is provided.
  *
  * For available pretrained models please see the [[https://sparknlp.org/models Models Hub]].
  *
  * For extended examples of usage, see the
  * [[https://github.com/JohnSnowLabs/spark-nlp/tree/master/src/test/scala/com/johnsnowlabs/nlp/embeddings/AutoGGUFEmbeddingsTest.scala AutoGGUFEmbeddingsTest]]
  * and the
  * [[https://github.com/JohnSnowLabs/spark-nlp/tree/master/examples/python/llama.cpp/llama.cpp_in_Spark_NLP_AutoGGUFEmbeddings.ipynb example notebook]].
  *
  * ==Note==
  * To use GPU inference with this annotator, make sure to use the Spark NLP GPU package and set
  * the number of GPU layers with the `setNGpuLayers` method.
  *
  * When using larger models, we recommend adjusting GPU usage with `setNCtx` and `setNGpuLayers`
  * according to your hardware to avoid out-of-memory errors.
  *
  * ==Example==
  *
  * {{{
  * import com.johnsnowlabs.nlp.base._
  * import com.johnsnowlabs.nlp.annotator._
  * import org.apache.spark.ml.Pipeline
  * import spark.implicits._
  *
  * val document = new DocumentAssembler().setInputCol("text").setOutputCol("document")
  *
  * val autoGGUFModel = AutoGGUFEmbeddings
  *   .pretrained()
  *   .setInputCols("document")
  *   .setOutputCol("embeddings")
  *   .setBatchSize(4)
  *   .setPoolingType("MEAN")
  *
  * val pipeline = new Pipeline().setStages(Array(document, autoGGUFModel))
  *
  * val data = Seq(
  *   "The moons of Jupiter are 77 in total, with 79 confirmed natural satellites and 2 man-made ones.")
  *   .toDF("text")
  * val result = pipeline.fit(data).transform(data)
  * result.select("embeddings.embeddings").show(truncate = false)
  * +------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
  * |embeddings                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
  * +------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
  * |[[-0.034486726, 0.07770534, -0.15982522, -0.017873349, 0.013914132, 0.036573686, -0.061842937, -0.024888353, -0.0055099702, -0.017409055, 0.016300408, -0.040329963, 0.07719318, 0.028313287, -0.0028683618, -0.08454637, 0.008769749, -0.036704306, 0.023090474, 0.054265227, -0.021859434, -0.06428978, -0.04479295, 0.020705963, 0.06497786, 0.059356716, 0.021834997, 0.00307514, 0.026292259, 0.014933891, 0.08744038, -0.02811151, 0.016781531, 0.015445955, -0.010924026, -0.04851611, 0.03925367, 0.039471917, 0.032168012, 0.008500139, 0.006320927, -0.04627625, -0.030094603, 0.0073103816, 0.03888035, -0.014504199, 0.0071682925, 0.031903747, 0.035689734, 6.025889E-4, -0.017142227, 0.04276457, -0.0065099197, -0.032690205, -0.0071476507, 0.07159226, -0.06369178, -0.01917436, 0.034397062, 4.0524136E-4, 0.10087232, 0.0033779414, -0.023441145, 0.07004529, 0.013459346, -0.0030516016, -0.035677772, 0.08170306, 0.07644568, -2.9037206E-4, 0.027696723, -0.006979564, 0.07478877, 0.002419309, -0.065887064, 0.012399765, 0.01388978, 0.039779745, -0.044001065, 0.049571555, 0.02699826, -1.0993673E-4, 0.057048023, -0.012186652, 0.06991711, -0.01775199, 0.008763964, 0.040139448, -0.050470676, 0.079204544, 0.08287526, -0.015052606, 0.022409894, 0.033971224, 0.0041023744, 0.005154973, -0.0023973265, 0.035931952, -0.051592406, -0.013217879, -0.011766036, -0.001341666, -0.01520842, -0.0027873935, 0.06215989, 0.0017772123, 0.026588673, -0.0012319541, 0.048925158, 0.0018818671, -0.04665316, -0.026011221, 0.024794303, -0.03221698, -0.036061365, -0.012871589, 0.03858385, -0.054618772, -0.012528424, 0.046601567, -0.016641323, -0.02248217, 0.0051510236, 0.012308001, 0.009533647, -0.044437744, 0.0181526, 0.038658425, -0.019162748, -0.042657536, -0.07463691, -0.020206723, -0.001992114, -0.017827753, -0.004949488, 0.03569916, -0.036901806, 0.024047423, -0.01176255, 0.0069288523, 0.004888182, -0.008302547, 0.02487946, -0.02501888, -0.029034596, 0.016700668, 0.014861418, -0.029827045, -0.03930421, 0.015791262, 0.042140704, 0.025974756, -0.01385641, -0.041974343, 0.018377684, -0.034494527, 0.010876806, 2.8707767E-5, 0.011115602, 0.030507023, 0.04605975, 0.004614653, -0.038494796, 0.036734566, -0.04692843, -0.01567684, -0.031658113, 0.02391712, -0.005947062, 0.058873415, -0.068531185, -0.08158785, -0.025101481, 0.008950388, 0.015929766, -0.021903077, 0.018994719, -0.03249043, 0.042135585, 0.020876372, 0.060674068, -0.040061917, -0.025402999, 0.0787141, -0.013670841, -0.029691942, -0.0139025645, -0.044027004, -0.04230467, 0.018172147, 0.018984137, 0.065545276, -0.035028107, -0.008717669, 0.0338165, -0.025190722, 0.041851245, 0.019414814, 0.0056071016, -0.0072911964, -0.0012467996, -0.018665427, 0.008620771, -0.03265344, -0.01232605, 0.07473815, 0.011423991, 0.025221122, -0.02990565, 0.016245041, 0.039097268, -0.0419563, -0.005965483, 0.007197967, -0.030940875, -0.03804368, -0.04292531, -0.018016882, 0.008934959, 0.0059682825, -0.008261543, 0.045022417, 0.027811566, -0.023849908, 0.07978606, 0.026160536, -0.05415099, -0.0015963146, 0.0057205516, 0.0019285348, -0.0024194561, -0.075180955, 0.043723788, -0.0031307312, -0.021267138, 0.0049094423, -0.017705547, -0.03113788, 0.029393613, 0.028107498, 0.023962894, -0.006400211, 0.0047220024, -0.004791728, -0.0612475, -0.022633713, -0.055356022, -0.051735647, -0.026498597, 0.064144164, -0.041956175, 0.026358996, 0.009545083, 0.0401399, 0.016320523, -0.01742617, -0.051827885, 0.020952651, -0.09349769, 0.0077742613, 0.0127063915, -0.09694972, 0.01825593, -0.025809746, -0.023807658, -0.061322056, -0.03036595, -0.042850453, 0.016346512, -0.030850109, 0.06914841, 0.03888319, 0.014849418, 0.0438333, -0.010128573, 0.04219727, -0.008909243, -0.008255766, -0.049361303, 0.013266433, -0.013412716, -0.009687615, -0.058058124, -0.015600165, 0.028476877, -0.0010635847, 0.014882733, 0.004831771, 0.0029835708, 0.011180718, -0.012270921, -0.0133244395, 0.026600977, 0.023855362, -0.006152916, 0.014690339, 0.023968417, -0.017229108, 0.01528586, -0.08777131, 0.033939373, -0.019934837, 0.06970268, 0.026455868, 0.027285637, -0.005311785, 0.0094126025, 0.026291631, 0.026128415, -0.063407406, 0.0043303776, 0.08847165, -0.014736371, 0.06232314, -0.017575618, 0.044070918, 0.010425953, 0.036870822, 0.08829932, -0.021934368, -0.0022041139, -0.04368227, 0.0043426557, -0.050648246, 0.019787138, 0.02631511, -0.028591301, -0.0035298439, -0.032720786, 0.015171295, 0.012051052, 0.03657424, 0.03493729, -0.01915843, -0.06919901, 0.052576005, -0.02496577, 3.3781756E-4, 0.034757055, 0.04252539, 0.022271162, 0.003679069, -0.020090645, -0.076098725, 0.019346641, -0.013718355, -0.02596826, -0.008985822, 0.010198825, -0.033658314, -0.021455139, -0.02188076, 0.029510919, 0.00912675, 0.02748955, 0.043546252, -0.010609957, 0.061771676, 0.027522756, -0.033174336, 0.061996575, 0.044645615, 0.008343542, -0.015155381, 0.032273028, 0.0190571, 0.006814276, -0.023040608, 0.01895875, -1.3078816E-4, -0.038015, -0.007965673, -0.018049296, 0.009604706, 0.029516926, -0.0038067005, -0.046961367, -0.06096347, 0.022511935, -0.008893266, -0.0031745974, -0.008551929, 0.020620983, 0.022748591, 0.061216854, -0.0023358185, -0.030410916, -0.01883453, 0.038523432, -0.020217339, -0.009582961, -0.09108717, -0.038076673, -0.08830739, -0.021963516, -0.014656793, 0.030958544, -0.047385667, 0.013812033, -0.0039438903, -0.017691644, -0.007842198, 0.019246731, -0.042066354, -0.01624266, 0.033428013, -0.022316974, -0.02606108, 0.0776681, 0.025132203, 0.007188184, 0.09359571, 0.026009275, -0.083058335, 0.0059954836, 0.036266316, -0.0071962625, -0.015784778, 0.03426829, -0.012409705, 0.02055743, 0.08018703, -0.03274366, -0.020153534, 0.009154507, -0.0021578076, 0.004452314, 0.03146502, 2.5478384E-4, -0.029444067, 0.039176658, 0.026131943, 0.012864497, -0.012571682, 0.0035173127, 0.04281633, -0.012199777, 0.045021012, 0.028395122, 0.041146915, 0.015197585, 2.8348848E-5, 0.03361076, -0.016277706, 0.039069086, 0.049454145, 0.047263898, -0.0041302345, -0.044127483, 0.033149, -0.0036231608, -0.040942162, 0.020708682, 0.01581302, 0.035588395, -0.031066746, 0.020127827, 0.05609774, 0.026941871, 0.035220087, 0.03410707, -0.024219546, -0.010093118, 0.055158913, 0.027861096, -0.03650994, -0.012704465, -0.0064905873, 0.013801114, -0.0049142144, -0.026353488, 0.04382013, 0.0074189957, -0.050098144, -0.083624475, -0.041212067, -0.05443863, -0.026611984, -0.015959414, 0.038016517, 0.01779429, -0.026165726, -0.020609194, -0.018494153, -0.014182199, 0.04947293, 0.008614389, -0.050055195, 0.0058284746, -0.018881215, 0.0031202831, -0.02938526, 0.009522214, -0.032818962, -0.06719835, 0.030367976, -0.08667114, -0.05367258, 0.015093505, 0.03127232, 0.04821936, 0.06434597, 0.005625465, -0.01977926, 0.008809443, 0.024813581, 0.01342158, -0.026959015, -0.033045888, 0.0030041072, -0.005423865, 0.0033837429, -0.039643973, 3.2898976E-4, 0.050922275, -0.020597331, 0.041328743, 0.03150495, -0.030991191, 0.009199436, 0.017099122, -0.056749612, 0.054165974, -0.00782225, -0.041106693, 0.0342821, 0.008178796, -0.03879954, 0.011418585, -0.020122766, -0.004162732, -0.029513981, -0.023144895, -0.03404659, -0.032330647, 0.017489996, -0.018637361, 0.044870645, 0.07327313, -0.038929492, 0.012251376, 0.009445071, 0.028711312, 0.022952495, 2.5056617E-4, -0.011952671, -0.029634628, 0.0074475124, 0.014870445, -0.007058077, 0.031818017, -0.043725632, 2.4192275E-4, -0.0051281555, 0.02459637, -0.01856664, -0.012994385, 2.3744743E-4, -0.015710728, -0.011913427, -0.0033933637, 0.020470029, -0.0026383223, -0.007450714, -0.025668243, 0.0038370835, 0.0069864546, -0.031892557, -0.025590355, 0.008811127, 0.033683486, -0.027566887, -0.035247803, -0.0020552, 0.031167574, 4.1876954E-4, 0.004011008, 0.009581751, -0.06596088, 0.003525403, 0.04214799, -0.018328575, -0.012032472, 0.04562276, -0.03827709, -0.0067513995, -0.066415586, 4.8579727E-4, -0.057676617, -0.04376187, 0.047975615, -0.017631179, 0.0020936003, -0.016453404, -0.023053054, -0.02165445, 4.9688464E-5, -0.004620303, -0.029303445, -0.09443451, 0.008280309, 0.016602539, 0.06254336, -0.036810383, 0.021666033, -0.019372962, -0.085447, 0.07329071, -0.0027712514, -0.018569533, 0.05896044, 0.00840332, -0.003379943, 0.0010938433, -0.012101751, -0.030394578, 0.05909685, -0.018303098, -0.062845334, -0.025827548, -0.03691681, -0.06943082, 0.013671754, -0.07554834, 0.09448334, -0.019023458, -0.007451085, -0.05743321, 0.0031043733, 0.026359402, -0.036562383, 0.012111404, -0.0065374514, -0.01373876, 0.04101282, -0.0039124484, -0.018738093, 0.008231626, 0.015183885, 0.0026201599, 0.0093357405, -0.10441194, 0.012438977, 0.05505744, 0.01610726, -0.032884836, 0.04118017, 0.0497767, 0.016669258, -0.0116701545, 0.051918082, -0.012475698, 0.038193032, 0.01833968, -0.004283018, 0.035354946, 0.038142014, -0.036299434, 0.02438769, -0.045589153, 0.015679903, 0.050791856, -0.040633995, -0.0027965212, 0.020624377, -0.02730683, 0.003629284, 0.024335133, -0.08731455, -0.024001595, -0.0034300734, 0.0013286119, -0.023314241, 4.882927E-4, -0.032832127, 0.0688801, 0.057335008, 0.0071718195, 0.04405023, -0.0060114767, 0.008105247, 0.055296537, -0.011131168, 0.027974527, -0.029077925, 0.036256842, 0.009142723, -0.083443135, -0.011950024, -0.06748717, -0.0016566556, -0.013202654, 0.0610416, -0.0466558, 0.011865008, -0.013205172, 0.02154032, -0.018239297, -0.01673549, 0.02226255, 0.014575712, 0.074248046, 0.032126796, -0.00841258, -0.008067024, 0.025695702, -0.03777066, -0.015264173, -0.012111247, 0.0082672, -0.01667376, 0.01555384, -0.08666634, 0.07541334, 0.05601258, -1.9999634E-5, 0.0064695827, -0.028761584, -0.042101488, -0.030295106, 0.024612803, -0.021254802, -0.014421, -0.046561938, -0.04371576, -0.009635446, 0.0472594, -0.05336762, 0.04668703, -0.024631223, 0.007230214, 0.012854281, -0.05598542, -0.015159397, -0.02251027, -0.004926787, -0.05523216, -0.03809542, -0.052173767, -0.026587853, -0.03616475, 0.02787456, 0.05931825, 0.027148476, -0.001709223, 0.013285086, -0.05756708, 0.053961262, 0.06480918, 0.027457427, 0.020375935, 0.020724382, 3.5838663E-4, 0.009585773, -4.4729502E-5, 0.02688194, -0.008155948, 0.022986492, 0.1019447, -0.0039361543, 0.023713963, -0.022660943, 0.01602265, -0.021562042, -0.038914952, -0.038994525, -0.050018083, -0.0018898722]]|
  * +------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
  * }}}
  *
  * @param uid
  *   required uid for storing annotator to disk
  * @groupname anno Annotator types
  * @groupdesc anno
  *   Required input and expected output annotator types
  * @groupname Ungrouped Members
  * @groupname param Parameters
  * @groupname setParam Parameter setters
  * @groupname getParam Parameter getters
  * @groupname Ungrouped Members
  * @groupprio param  1
  * @groupprio anno  2
  * @groupprio Ungrouped 3
  * @groupprio setParam  4
  * @groupprio getParam  5
  * @groupdesc param
  *   A list of (hyper-)parameter keys this annotator can take. Users can set and get the
  *   parameter values through setters and getters, respectively.
  */
class AutoGGUFEmbeddings(override val uid: String)
    extends AnnotatorModel[AutoGGUFEmbeddings]
    with HasBatchedAnnotate[AutoGGUFEmbeddings]
    with HasEngine
    with HasLlamaCppModelProperties
    with HasProtectedParams {

  override val inputAnnotatorTypes: Array[AnnotatorType] = Array(AnnotatorType.DOCUMENT)
  override val outputAnnotatorType: AnnotatorType = AnnotatorType.SENTENCE_EMBEDDINGS

  /** Annotator reference id. Used to identify elements in metadata or to refer to this annotator
    * type
    */
  def this() = this(Identifiable.randomUID("AutoGGUFModel"))

  private var _model: Option[Broadcast[GGUFWrapper]] = None

  /** @group getParam */
  def getModelIfNotSet: GGUFWrapper = _model.get.value

  /** @group setParam */
  def setModelIfNotSet(spark: SparkSession, wrapper: GGUFWrapper): this.type = {
    if (_model.isEmpty) {
      _model = Some(spark.sparkContext.broadcast(wrapper))
    }

    setGpuSupportIfAvailable(spark)
  }

  private[johnsnowlabs] def setEngine(engineName: String): this.type = set(engine, engineName)

  setDefault(engine -> LlamaCPP.name, embedding -> true, poolingType -> "MEAN", nCtx -> 512)

  override def onWrite(path: String, spark: SparkSession): Unit = {
    super.onWrite(path, spark)
    getModelIfNotSet.saveToFile(path)
  }

  /** Completes the batch of annotations.
    *
    * @param batchedAnnotations
    *   Annotations (single element arrays) in batches
    * @return
    *   Completed text sequences
    */
  override def batchAnnotate(batchedAnnotations: Seq[Array[Annotation]]): Seq[Seq[Annotation]] = {
    require(
      getEmbedding,
      "Embeddings have been manually disabled. Please enable them with setEmbedding(true).")
    val annotations: Seq[Annotation] = batchedAnnotations.flatten
    if (annotations.nonEmpty) {

      val modelParams =
        getModelParameters.setNParallel(getBatchSize) // set parallel decoding to batch size

      val model: LlamaModel = getModelIfNotSet.getSession(modelParams)

      val annotationsText = annotations.map(_.result)

      // Return embeddings in annotation
      val (embeddings: Array[Array[Float]], metadata: Map[String, String]) =
        try {
          (model.requestBatchEmbeddings(annotationsText.toArray), Map.empty)
        } catch {
          case e: Exception =>
            logger.error("Error in llama.cpp embeddings", e)
            (Array.empty[Array[Float]], Map("llamacpp_exception" -> e.getMessage))
        }

      // Choose empty text for result annotations
      annotations.zip(embeddings).map { case (annotation, embedding) =>
        Seq(
          new Annotation(
            annotatorType = annotation.annotatorType,
            begin = annotation.begin,
            end = annotation.end,
            result = annotation.result,
            metadata = annotation.metadata ++ metadata,
            embeddings = embedding))
      }
    } else Seq(Seq.empty[Annotation])
  }
}

trait ReadablePretrainedAutoGGUFEmbeddings
    extends ParamsAndFeaturesReadable[AutoGGUFEmbeddings]
    with HasPretrained[AutoGGUFEmbeddings] {
  override val defaultModelName: Some[String] = Some("nomic-embed-text-v1.5.f16.gguf")
  override val defaultLang: String = "en"

  /** Java compliant-overrides */
  override def pretrained(): AutoGGUFEmbeddings = super.pretrained()

  override def pretrained(name: String): AutoGGUFEmbeddings = super.pretrained(name)

  override def pretrained(name: String, lang: String): AutoGGUFEmbeddings =
    super.pretrained(name, lang)

  override def pretrained(name: String, lang: String, remoteLoc: String): AutoGGUFEmbeddings =
    super.pretrained(name, lang, remoteLoc)
}

trait ReadAutoGGUFEmbeddings {
  this: ParamsAndFeaturesReadable[AutoGGUFEmbeddings] =>

  def readModel(instance: AutoGGUFEmbeddings, path: String, spark: SparkSession): Unit = {
    val model: GGUFWrapper = GGUFWrapper.readModel(path, spark)
    instance.setModelIfNotSet(spark, model)
  }

  addReader(readModel)

  def loadSavedModel(modelPath: String, spark: SparkSession): AutoGGUFEmbeddings = {
    // TODO potentially enable download from HF-URLS
    val localPath: String = ResourceHelper.copyToLocal(modelPath)
    val annotatorModel = new AutoGGUFEmbeddings()
    annotatorModel
      .setModelIfNotSet(spark, GGUFWrapper.read(spark, localPath))
      .setEngine(LlamaCPP.name)

    val metadata = LlamaModel.getMetadataFromFile(localPath)
    if (metadata.nonEmpty) annotatorModel.setMetadata(metadata)
    annotatorModel
  }
}

/** This is the companion object of [[AutoGGUFEmbeddings]]. Please refer to that class for the
  * documentation.
  */
object AutoGGUFEmbeddings extends ReadablePretrainedAutoGGUFEmbeddings with ReadAutoGGUFEmbeddings
